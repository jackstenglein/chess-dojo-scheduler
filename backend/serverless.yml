# Welcome to Serverless!
#
# This file is the main config file for your service.
# It's very minimal at this point and uses default values.
# You can always add more config options for more control.
# We've included some commented out config examples here.
# Just uncomment any of them to get that config option.
#
# For full config options, check the docs:
#    docs.serverless.com
#
# Happy Coding!

service: chess-dojo-scheduler
# app and org for use with dashboard.serverless.com
#app: your-app-name
#org: your-org-name

# You can pin your service to only deploy with a specific Serverless version
# Check out our docs for more details
frameworkVersion: '3'

plugins:
  - serverless-plugin-custom-roles

provider:
  name: aws
  runtime: go1.x
  region: us-east-1
  environment:
    stage: ${sls:stage}
    frontendHost: ${file(./config-${sls:stage}.yml):frontendHost}
    discordFindGameChannelId: ${file(./config-${sls:stage}.yml):discordFindGameChannelId}
    discordAuth: ${file(./discord.yml):discordAuth}
  httpApi:
    cors: true
    authorizers:
      serviceAuthorizer:
        identitySource: $request.header.Authorization
        issuerUrl: !GetAtt CognitoUserPool.ProviderURL
        audience:
          - Ref: UserClient

package:
  individually: true
  patterns:
    - '!./**'

functions:
  ######### Admin Endpoints ##############

  adminListUsers:
    handler: bin/admin/user/list
    package:
      patterns:
        - ./bin/admin/user/list
    events:
      - httpApi:
          path: /admin/user
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:Scan
        Resource: !GetAtt UsersTable.Arn

  adminListAvailabilities:
    handler: bin/admin/availability/list
    package:
      patterns:
        - ./bin/admin/availability/list
    events:
      - httpApi:
          path: /admin/availability
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt AvailabilitiesTable.Arn

  adminListMeetings:
    handler: bin/admin/meeting/list
    package:
      patterns:
        - ./bin/admin/meeting/list
    events:
      - httpApi:
          path: /admin/meeting
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt MeetingsTable.Arn

  adminGetStatistics:
    handler: bin/admin/statistics/get
    package:
      patterns:
        - ./bin/admin/statistics/get
    events:
      - httpApi:
          path: /admin/statistics
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource:
          - !GetAtt UsersTable.Arn
          - !GetAtt AvailabilitiesTable.Arn
          - !GetAtt MeetingsTable.Arn

  ######### User Endpoints ###############

  createUser:
    handler: bin/user/create
    package:
      patterns:
        - ./bin/user/create
    events:
      - cognitoUserPool:
          pool: ${sls:stage}-chess-dojo-scheduler-auth-pool
          trigger: PostConfirmation
          existing: true
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: !GetAtt UsersTable.Arn

  setUser:
    handler: bin/user/set
    package:
      patterns:
        - ./bin/user/set
    events:
      - httpApi:
          path: /user
          method: put
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn

  getUser:
    handler: bin/user/get
    package:
      patterns:
        - ./bin/user/get
    events:
      - httpApi:
          path: /user
          method: get
          authorizer: serviceAuthorizer
      - httpApi:
          path: /public/user/{username}
          method: get
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn

  updateRatings:
    handler: bin/user/ratings/update
    package:
      patterns:
        - ./bin/user/ratings/update
    events:
      - schedule: cron(0 0 * * ? *)
    timeout: 300
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
          - dynamodb:PartiQLUpdate
        Resource: !GetAtt UsersTable.Arn

  ########## Availability Endpoints ##############

  setAvailability:
    handler: bin/availability/set
    package:
      patterns:
        - ./bin/availability/set
    events:
      - httpApi:
          path: /availability
          method: put
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource: !GetAtt AvailabilitiesTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn

  bookAvailability:
    handler: bin/availability/book
    package:
      patterns:
        - ./bin/availability/book
    events:
      - httpApi:
          path: /availability/book
          method: put
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource: !GetAtt MeetingsTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource: !GetAtt AvailabilitiesTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn

  deleteAvailability:
    handler: bin/availability/delete
    package:
      patterns:
        - ./bin/availability/delete
    events:
      - httpApi:
          path: /availability/{id}
          method: delete
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:DeleteItem
          - dynamodb:UpdateItem
        Resource: !GetAtt AvailabilitiesTable.Arn

  getAvailability:
    handler: bin/availability/get
    package:
      patterns:
        - ./bin/availability/get
    events:
      - httpApi:
          path: /availability
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - ''
              - - !GetAtt AvailabilitiesTable.Arn
                - '/index/EndSearchIndex'
          - !GetAtt AvailabilitiesTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn

  ########## Meeting Endpoints ##############

  getMeeting:
    handler: bin/meeting/get
    package:
      patterns:
        - ./bin/meeting/get
    events:
      - httpApi:
          path: /meeting/{id}
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource:
          - !GetAtt MeetingsTable.Arn
          - !GetAtt UsersTable.Arn

  listMeetings:
    handler: bin/meeting/list
    package:
      patterns:
        - ./bin/meeting/list
    events:
      - httpApi:
          path: /meeting
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - ''
              - - !GetAtt MeetingsTable.Arn
                - '/index/OwnerIndex'
          - Fn::Join:
              - ''
              - - !GetAtt MeetingsTable.Arn
                - '/index/ParticipantIndex'

  cancelMeeting:
    handler: bin/meeting/cancel
    package:
      patterns:
        - ./bin/meeting/cancel
    events:
      - httpApi:
          path: /meeting/cancel/{id}
          method: put
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource:
          - !GetAtt MeetingsTable.Arn
          - !GetAtt UsersTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource:
          - !GetAtt MeetingsTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource:
          - !GetAtt AvailabilitiesTable.Arn

  ########## Calendar Endpoints ##############

  getCalendar:
    handler: bin/calendar/get
    package:
      patterns:
        - ./bin/calendar/get
    events:
      - httpApi:
          path: /calendar
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - ''
              - - !GetAtt MeetingsTable.Arn
                - '/index/OwnerIndex'
          - Fn::Join:
              - ''
              - - !GetAtt MeetingsTable.Arn
                - '/index/ParticipantIndex'
          - Fn::Join:
              - ''
              - - !GetAtt AvailabilitiesTable.Arn
                - '/index/EndSearchIndex'
          - !GetAtt AvailabilitiesTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource:
          - !GetAtt MeetingsTable.Arn
          - !GetAtt AvailabilitiesTable.Arn

  ########## Game Endpoints ##############

  createGame:
    handler: bin/game/create
    package:
      patterns:
        - ./bin/game/create
    events:
      - httpApi:
          path: /game
          method: post
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource:
          - !GetAtt UsersTable.Arn
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource:
          - !GetAtt GamesTable.Arn

  getGame:
    handler: bin/game/get
    package:
      patterns:
        - ./bin/game/get
    events:
      - httpApi:
          path: /game/{cohort}/{id}
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource:
          - !GetAtt GamesTable.Arn

  createGameComment:
    handler: bin/game/comment/create
    package:
      patterns:
        - ./bin/game/comment/create
    events:
      - httpApi:
          path: /game/{cohort}/{id}/comment
          method: post
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource:
          - !GetAtt GamesTable.Arn

  listGamesByCohort:
    handler: bin/game/list/cohort
    package:
      patterns:
        - ./bin/game/list/cohort
    events:
      - httpApi:
          path: /game/{cohort}
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - !GetAtt GamesTable.Arn

  listGamesByOwner:
    handler: bin/game/list/owner
    package:
      patterns:
        - ./bin/game/list/owner
    events:
      - httpApi:
          path: /game
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - ''
              - - !GetAtt GamesTable.Arn
                - '/index/OwnerIndex'
          - Fn::Join:
              - ''
              - - !GetAtt GamesTable.Arn
                - '/index/WhiteIndex'
          - Fn::Join:
              - ''
              - - !GetAtt GamesTable.Arn
                - '/index/BlackIndex'

  ########## Requirement Endpoints ##############

  listRequirements:
    handler: bin/requirement/list
    package:
      patterns:
        - ./bin/requirement/list
    events:
      - httpApi:
          path: /requirement/{cohort}
          method: get
          authorizer: serviceAuthorizer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:Scan
        Resource:
          - !GetAtt RequirementsTable.Arn

resources:
  Conditions:
    IsProd: !Equals ['${sls:stage}', 'prod']

  Resources:
    ######### Cognito Resources ###############

    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${sls:stage}-chess-dojo-scheduler-auth-pool
        UsernameConfiguration:
          CaseSensitive: false
        AliasAttributes:
          - email
        MfaConfiguration: OFF
        Schema:
          - Name: email
            Required: true
            Mutable: true
        Policies:
          PasswordPolicy:
            MinimumLength: 6
        AutoVerifiedAttributes: ['email']

    UserClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${sls:stage}-chess-dojo-scheduler-auth-client
        GenerateSecret: false
        UserPoolId: { Ref: CognitoUserPool }
        ExplicitAuthFlows:
          - ALLOW_USER_SRP_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
        AllowedOAuthFlowsUserPoolClient: true
        AllowedOAuthFlows:
          - code
        AllowedOAuthScopes:
          - openid
          - email
          - profile
        CallbackURLs:
          - ${file(./config-${sls:stage}.yml):frontendHost}
        LogoutURLs:
          - ${file(./config-${sls:stage}.yml):frontendHost}
        SupportedIdentityProviders:
          - COGNITO
          - Google
        AccessTokenValidity: 24
        IdTokenValidity: 24

    UserPoolDomain:
      Type: AWS::Cognito::UserPoolDomain
      Properties:
        UserPoolId: { Ref: CognitoUserPool }
        Domain: user-pool-domain-${sls:stage}-chess-dojo-scheduler

    UserPoolIdentityProvider:
      Type: AWS::Cognito::UserPoolIdentityProvider
      Properties:
        UserPoolId: { Ref: CognitoUserPool }
        ProviderName: 'Google'
        ProviderDetails:
          client_id: ${file(./oauth.yml):client_id}
          client_secret: ${file(./oauth.yml):client_secret}
          authorize_scopes: 'profile email openid'
        ProviderType: 'Google'
        AttributeMapping:
          email: 'email'
          name: 'name'
          username: 'sub'
          email_verified: 'email_verified'

    ######### End Cognito Resources ###############

    ######### DynamoDB Resources ##################

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${sls:stage}-users
        AttributeDefinitions:
          - AttributeName: username
            AttributeType: S
        KeySchema:
          - AttributeName: username
            KeyType: HASH
        BillingMode: !If
          - IsProd
          - PROVISIONED
          - PAY_PER_REQUEST
        ProvisionedThroughput: !If
          - IsProd
          - ReadCapacityUnits: 1
            WriteCapacityUnits: 1
          - !Ref AWS::NoValue

    AvailabilitiesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${sls:stage}-availabilities
        AttributeDefinitions:
          - AttributeName: owner
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: status
            AttributeType: S
          - AttributeName: endTime
            AttributeType: S
        KeySchema:
          - AttributeName: owner
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: EndSearchIndex
            KeySchema:
              - AttributeName: status
                KeyType: HASH
              - AttributeName: endTime
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput: !If
              - IsProd
              - ReadCapacityUnits: 1
                WriteCapacityUnits: 1
              - !Ref AWS::NoValue
        BillingMode: !If
          - IsProd
          - PROVISIONED
          - PAY_PER_REQUEST
        ProvisionedThroughput: !If
          - IsProd
          - ReadCapacityUnits: 1
            WriteCapacityUnits: 1
          - !Ref AWS::NoValue
        TimeToLiveSpecification:
          AttributeName: expirationTime
          Enabled: true

    MeetingsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${sls:stage}-meetings
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: owner
            AttributeType: S
          - AttributeName: participant
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: OwnerIndex
            KeySchema:
              - AttributeName: owner
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
          - IndexName: ParticipantIndex
            KeySchema:
              - AttributeName: participant
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TimeToLiveSpecification:
          AttributeName: expirationTime
          Enabled: true

    RequirementsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${sls:stage}-requirements
        AttributeDefinitions:
          - AttributeName: status
            AttributeType: S
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: status
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        BillingMode: !If
          - IsProd
          - PROVISIONED
          - PAY_PER_REQUEST
        ProvisionedThroughput: !If
          - IsProd
          - ReadCapacityUnits: 1
            WriteCapacityUnits: 1
          - !Ref AWS::NoValue

    GamesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${sls:stage}-games
        AttributeDefinitions:
          - AttributeName: cohort
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: owner
            AttributeType: S
          - AttributeName: white
            AttributeType: S
          - AttributeName: black
            AttributeType: S
        KeySchema:
          - AttributeName: cohort
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        BillingMode: !If
          - IsProd
          - PROVISIONED
          - PAY_PER_REQUEST
        ProvisionedThroughput: !If
          - IsProd
          - ReadCapacityUnits: 1
            WriteCapacityUnits: 1
          - !Ref AWS::NoValue
        GlobalSecondaryIndexes:
          - IndexName: OwnerIndex
            KeySchema:
              - AttributeName: owner
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: INCLUDE
              NonKeyAttributes:
                - white
                - black
                - date
                - headers
            ProvisionedThroughput: !If
              - IsProd
              - ReadCapacityUnits: 1
                WriteCapacityUnits: 1
              - !Ref AWS::NoValue
          - IndexName: WhiteIndex
            KeySchema:
              - AttributeName: white
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: INCLUDE
              NonKeyAttributes:
                - black
                - date
                - owner
                - headers
            ProvisionedThroughput: !If
              - IsProd
              - ReadCapacityUnits: 1
                WriteCapacityUnits: 1
              - !Ref AWS::NoValue
          - IndexName: BlackIndex
            KeySchema:
              - AttributeName: black
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: INCLUDE
              NonKeyAttributes:
                - white
                - date
                - owner
                - headers
            ProvisionedThroughput: !If
              - IsProd
              - ReadCapacityUnits: 1
                WriteCapacityUnits: 1
              - !Ref AWS::NoValue
